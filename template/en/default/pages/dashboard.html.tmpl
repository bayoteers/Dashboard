[%#
  # The contents of this file are subject to the Mozilla Public
  # License Version 1.1 (the "License"); you may not use this file
  # except in compliance with the License. You may obtain a copy of
  # the License at http://www.mozilla.org/MPL/
  #
  # Software distributed under the License is distributed on an "AS
  # IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
  # implied. See the License for the specific language governing
  # rights and limitations under the License.
  #
  # The Original Code is the Bugzilla Example Plugin.
  #
  # The Initial Developer of the Original Code is Canonical Ltd.
  # Portions created by Canonical Ltd. are Copyright (C) 2009
  # Canonical Ltd. All Rights Reserved.
  #
  # Contributor(s): 
  #   Stephen Jayna <ext-stephen.jayna@nokia.com>
  #   Allan Savolainen <ext-jari.a.savolainen@nokia.com>
  #%]

[% USE Bugzilla %]

[% PROCESS global/header.html.tmpl
    title = "Bugzilla Dashboard" 
    style_urls = ['extensions/Dashboard/web/css/smoothness/jquery-ui-1.8.5.custom.css','extensions/Dashboard/web/css/dashboard.css','extensions/Dashboard/web/css/colorbox.css']
%]

[% IF dashboard_jquery_path %]
  <script type="text/javascript" src="[% dashboard_jquery_path %]"></script>
[% END %]
<script type="text/javascript" src="extensions/Dashboard/web/js/jquery-ui-1.8.5.custom.min.js"></script>
<script type="text/javascript" src="extensions/Dashboard/web/js/jquery.colorbox-min.js"></script>
<script type="text/javascript" src="extensions/Dashboard/web/js/jquery.jfeed.js"></script>
<script type="text/javascript" src="extensions/Dashboard/web/js/jquery.md5.js"></script>
<script type="text/javascript" src="extensions/Dashboard/web/js/jquery.Storage.js"></script>

<script>
var browser_quality = 1;
if (navigator.userAgent.match(/[% Bugzilla.params.dashboard_browsers_warn %]/)) {
	browser_quality = 0;
}
if (navigator.userAgent.match(/[% Bugzilla.params.dashboard_browsers_block %]/)) {
	browser_quality = -1;
}
</script>

<div id="ajax_message"></div>

[% active_widgets = 0 %]

<h1 align="center"><a href="#" id="dashboard-link">Dashboard</a></h1>

<div id="dashboard">

  <div id="columns">

    <ul id="column-1" class="column">
      [% FOREACH widget IN top_column %]
      	[% IF widget.id && widget.id > 0 %]
	      	[% active_widgets = active_widgets + 1 %]
      	  <li class="widget color-[% widget.color %]" id="widget[% widget.id %]">
      	    <div class="widget-head">
      	      <h3>[% widget.title %]</h3>
      	    </div>
      	    <div class="widget-content">
      	      <div align='center'><img class='loader' src='extensions/Dashboard/web/css/img/ajax-loader.gif'></div>
      	    </div>
       	  </li>
      	[% END %]
      [% END %]
    </ul>
  
  <br clear="both"> 
  
    <ul id="column0" class="column" style="width:[% column.shift %]%">
      [% cur_column = columns.shift %]
      [% FOREACH widget IN cur_column %]
      	[% IF widget.id && widget.id > 0 %]
	      	[% active_widgets = active_widgets + 1 %]
      	  <li class="widget color-[% widget.color %]" id="widget[% widget.id %]">
      	    <div class="widget-head">
      	      <h3>[% widget.title %]</h3>
      	    </div>
      	    <div class="widget-content">
      	      <div align='center'><img class='loader' src='extensions/Dashboard/web/css/img/ajax-loader.gif'></div>
      	    </div>
       	  </li>
      	[% END %]
      [% END %]
    </ul>
    
    [% FOREACH i IN [1 .. preferences.columns] %]
      [% cur_column = columns.shift %]
      <ul id="column[% i %]" class="column" style="width:[% column.shift %]%">
        [% FOREACH widget IN cur_column %]
          [% IF widget.id && widget.id > 0 %]
	      	[% active_widgets = active_widgets + 1 %]
            <li class="widget color-[% widget.color %]" id="widget[% widget.id %]">
              <div class="widget-head">
                <h3>[% widget.title %]</h3>
              </div>
              <div class="widget-content">
                <div align='center'><img class='loader' src='extensions/Dashboard/web/css/img/ajax-loader.gif'></div>
              </div>
            </li>
          [% END %]
        [% END %]
      </ul>
    [% END %]
  </div>
</div>

<br clear="both">
<br>

<div style="display:none">
	<div id="dashboard" class="dashboard-main">
		<h3>Dashboard</h3>
		<ul id="widget-buttons">
			<li id="button-overlay"><a class="overlay-open" href="page.cgi?id=dashboard_overlay.html">Open overlay</a></li>
			<li id="button-add-column"><a onclick="return AddColumn();">Add column</a></li>
			<li id="button-save-widgets"><a onclick="return SaveWidgets();">Save prefs</a></li>
			<li id="button-del-column"><a onclick="return DelColumn();">Delete column</a></li>
		</ul>
		<div class="widget-divider"></div>
		<ul id="widget-buttons">
			<li id="button-new-widget"><a onclick="return AddWidget('url');">New URL</a></li>
			<li id="button-new-widget"><a onclick="return AddWidget('mybugs');">New My Bugs</a></li>
			<li id="button-new-rss"><a onclick="return AddWidget('rss');">New RSS</a></li>
			<li id="button-new-xeyes"><a onclick="return AddWidget('xeyes');">New Xeyes</a></li>
		</ul>
		<div class="widget-divider"></div>
		<p id="dashboard_notify">Welcome to Dashboard!</p>
	</div>
</div>

<script>
	var warning = false;
	if (browser_quality==0)
	{
		warning = '<p style="color:red">Your current web browser is not compliant with the Dashboard, please use Firefox instead, thank you.</p>';
		$('#dashboard_notify').append(warning);
	}
	if (browser_quality<0) {
		$('#dashboard').html('<h2 style="text-align:center">Your current web browser is not currently supported to access the Dashboard, please use Firefox instead, thank you.</h2>');
	}
	else {
		$('#dashboard-link').colorbox({width:"384px", inline:true, href:".dashboard-main"});
		[% IF active_widgets==0 %]
			$(document).ready(function(){
				$.colorbox({width:"384px", inline:true, href:".dashboard-main"});
			});
		[% ELSE %]
			if (warning) {
				$(document).ready(function(){
					$.colorbox({width:"384px", inline:true, href:".dashboard-main"});
				});
			}
		[% END %]
	}
</script>

[% IF widget_error %]
  <script>
    alert("[% widget_error | replace('\"','\\"') %]");
  </script>
[% END %]

<script type="text/javascript" src="extensions/Dashboard/web/js/dashboard.js"></script>

[% PROCESS global/footer.html.tmpl %]

